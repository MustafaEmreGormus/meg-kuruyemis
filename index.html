<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MEG KURUYEMÄ°Å | Dinamik & AI Destekli</title>
    
    <script src="https://cdn.jsdelivr.net/npm/fuse.js/dist/fuse.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background-color: #f4f4f4; padding-bottom: 50px; }
        header { text-align: center; padding: 20px; background: aqua; border-bottom: 3px solid #2d5a27; }
        header img { width: 250px; height: auto; }
        .container { width: 100%; max-width: 1400px; margin: auto; background-color: gold; padding: 20px; box-sizing: border-box; }

        /* YAN PANEL */
        .yan-panel { height: 100%; width: 0; position: fixed; z-index: 2000; top: 0; right: 0; background-color: white; overflow-x: hidden; transition: 0.5s; box-shadow: -5px 0 15px rgba(0,0,0,0.2); }
        .panel-icerik { padding: 30px; width: 300px; }
        .input-grubu { margin-top: 15px; }
        .input-grubu input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        
        /* BUTONLAR */
        .filtre-btn, .akilliara, .giris-btn, .btn-ekle, .btn-cikar { cursor: pointer; border: none; font-weight: bold; transition: 0.3s; border-radius: 20px; }
        .filtre-btn { padding: 10px 20px; margin: 5px; background: blue; color: white; }
        .akilliara { padding: 12px 20px; background: blue; color: white; margin-left: 10px; }
        .giris-btn { background: orange; color: white; width: 100%; padding: 15px; margin-top: 15px; }
        .btn-ekle { background-color: darkgreen; color: white; padding: 10px; width: 100%; margin-top: 10px; }
        .btn-ekle:disabled { background-color: #7f8c8d; cursor: not-allowed; }
        .btn-cikar { background-color: #e74c3c; color: white; padding: 2px 8px; font-size: 12px; margin-left: 10px; border-radius: 5px; }

        /* ÃœRÃœN TASARIMI */
        .urun-listesi { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .urun-karti { background: red; padding: 15px; border-radius: 10px; color: white; text-align: center; }
        .urun-karti img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; }
        .gramaj-secici { margin: 10px 0; padding: 5px; border-radius: 5px; width: 90%; cursor: pointer; }

        /* AI DANIÅMAN */
        .ai-danisman { background: #fff; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px dashed blue; }
        footer { background: #333; color: white; padding: 40px 20px; text-align: center; margin-top: 50px; }

        @media (max-width: 768px) {
            .urun-listesi { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            #ai-arama { width: 60%; }
        }
        .sepet-ozeti { background: white; padding: 20px; margin-top: 30px; border-radius: 10px; color: black; }
    </style>
</head>
<body>

<header>
    <img src="images/llogo.jpg" alt="MEG Logo">
    <h1>MEG KURUYEMÄ°Å</h1>
    <div style="text-align: right; padding-right: 20px;" id="kullanici-alani">
        <button onclick="panelAc('giris')" style="background:none; border:none; cursor:pointer; font-size:1.1em;">ğŸ‘¤ GiriÅŸ Yap</button> | 
        <button onclick="panelAc('kayit')" style="background:none; border:none; cursor:pointer; font-size:1.1em;">ğŸ“ KayÄ±t Ol</button>
    </div>
</header>

<div id="yanPanel" class="yan-panel">
    <div style="text-align: right; padding: 10px;"><button onclick="panelKapat()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button></div>
    <div class="panel-icerik" id="panelIcerik"></div>
</div>

<div class="container">
    <div style="text-align:center;">
        <button class="filtre-btn" onclick="filtrele('hepsi')">Hepsi</button>
        <button class="filtre-btn" onclick="filtrele('kuruyemis')">KuruyemiÅŸ</button>
        <button class="filtre-btn" onclick="filtrele('sekerleme')">Åekerleme</button>
        <br><br>
        <input type="text" id="ai-arama" placeholder="AI ile Ã¼rÃ¼n ara..." style="padding:12px; width:50%; border-radius:25px; border:2px solid green;">
        <button class="akilliara" onclick="aiAra()">ğŸ” AkÄ±llÄ± Ara</button>
    </div>

    <div class="urun-listesi" id="urun-kutusu">
        <p style="text-align:center; color:white;">VeritabanÄ±na baÄŸlanÄ±lÄ±yor...</p>
    </div>

    <div class="ai-danisman">
        <h3>ğŸ¤– MEG AI DanÄ±ÅŸman</h3>
        <p id="ai-cevap">Merhaba! Sana yardÄ±mcÄ± olabilirim.</p>
        <input type="text" id="ai-soru" placeholder="AI'ye sor..." style="width:70%; padding:10px;">
        <button onclick="aiDanis()" class="akilliara">Sor</button>
    </div>

    <div class="sepet-ozeti">
        <h3>ğŸ›’ Sepetiniz</h3>
        <ul id="sepet-listesi"><li>Sepetiniz boÅŸ.</li></ul>
        
        <div id="adres-alani" style="margin-top: 15px; display: none;">
            <label for="musteri-adres" style="font-weight: bold; display: block; margin-bottom: 5px;">Teslimat Adresi:</label>
            <textarea id="musteri-adres" placeholder="LÃ¼tfen aÃ§Ä±k adresinizi buraya yazÄ±nÄ±z..." 
                style="width: 100%; height: 80px; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; font-family: inherit;"></textarea>
        </div>

        <h3 style="margin-top: 20px;">Toplam: <span id="toplam-fiyat">0</span> TL</h3>
        <button onclick="stokGuncelleVeGonder()" style="background:#27ae60; color:white; padding:15px; width:100%; border:none; border-radius:10px; font-weight:bold; cursor:pointer; transition: 0.3s;">
            SipariÅŸi Onayla & WhatsApp'a GeÃ§
        </button>
    </div>
</div>

<footer>
    <h2>BÄ°Z KÄ°MÄ°Z?</h2>
    <p>Â© 2026 MEG KuruyemiÅŸ - TÃ¼m HaklarÄ± SaklÄ±dÄ±r.</p>
</footer>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSy...", 
        authDomain: "meg-kuruyemis.firebaseapp.com",
        projectId: "meg-kuruyemis",
        storageBucket: "meg-kuruyemis.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let sepet = [];
    let toplam = 0;

    function urunleriYukle() {
        const urunKutusu = document.getElementById("urun-kutusu");
        db.collection("urunler").onSnapshot((querySnapshot) => {
            urunKutusu.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const urun = doc.data();
                const id = doc.id;
                const stokVarMi = urun.stok > 0;
                const urunResmi = urun.resim ? urun.resim : `https://via.placeholder.com/300x300?text=${urun.ad}`;

                urunKutusu.innerHTML += `
                    <div class="urun-karti" data-kategori="${urun.kategori}">
                        <img src="${urunResmi}" alt="${urun.ad}">
                        <h3>${urun.ad}</h3>
                        <p style="font-size:0.9em;">Stok: ${urun.stok || 0} Adet</p>
                        <select id="gramaj-${id}" onchange="fiyatHesapla('${id}', ${urun.kgFiyat})" class="gramaj-secici">
                            <option value="0.25">250 gr</option>
                            <option value="0.5">500 gr</option>
                            <option value="1">1 kg</option>
                        </select>
                        <p id="fiyat-gosterge-${id}" style="font-size:1.3em; font-weight:bold;">
                            ${(urun.kgFiyat * 0.25).toFixed(2)} TL
                        </p>
                        <button class="btn-ekle" ${stokVarMi ? '' : 'disabled'} onclick="sepeteEkleDinamik('${id}', '${urun.ad}')">
                            ${stokVarMi ? 'Sepete Ekle' : 'Stokta Yok'}
                        </button>
                    </div>`;
            });
        });
    }

    function fiyatHesapla(id, kgFiyat) {
        const oran = document.getElementById(`gramaj-${id}`).value;
        const sonuc = (kgFiyat * oran).toFixed(2);
        document.getElementById(`fiyat-gosterge-${id}`).innerText = sonuc + " TL";
    }

    function sepeteEkleDinamik(id, ad) {
        const liste = document.getElementById(`gramaj-${id}`);
        const gramajMetni = liste.options[liste.selectedIndex].text;
        const anlikFiyat = parseFloat(document.getElementById(`fiyat-gosterge-${id}`).innerText);

        sepet.push({ id: id, ad: ad + " (" + gramajMetni + ")", fiyat: anlikFiyat, miktar: 1 });
        toplam += anlikFiyat;
        guncelle();
    }

    function guncelle() {
        const liste = document.getElementById('sepet-listesi');
        const adresAlani = document.getElementById('adres-alani');
        
        if(sepet.length === 0) {
            liste.innerHTML = "<li>Sepetiniz boÅŸ.</li>";
            adresAlani.style.display = "none";
        } else {
            adresAlani.style.display = "block";
            liste.innerHTML = sepet.map((i, index) => `
                <li>${i.ad} - ${i.fiyat.toFixed(2)} TL 
                <button class="btn-cikar" onclick="sepettenCikar(${index})">x</button></li>`).join('');
        }
        document.getElementById('toplam-fiyat').innerText = toplam.toFixed(2);
    }

    function sepettenCikar(index) {
        toplam -= sepet[index].fiyat;
        sepet.splice(index, 1);
        guncelle();
    }

    async function stokGuncelleVeGonder() {
        const adres = document.getElementById('musteri-adres').value;
        if (sepet.length === 0) { alert("Sepetiniz boÅŸ!"); return; }
        if (!adres || adres.trim().length < 10) { alert("LÃ¼tfen geÃ§erli bir adres giriniz."); return; }

        try {
            for (let urun of sepet) {
                const urunRef = db.collection("urunler").doc(urun.id);
                await db.runTransaction(async (transaction) => {
                    const sfDoc = await transaction.get(urunRef);
                    if (!sfDoc.exists) throw "ÃœrÃ¼n sistemde bulunamadÄ±!";
                    const yeniStok = sfDoc.data().stok - urun.miktar;
                    if (yeniStok < 0) throw urun.ad + " iÃ§in stok yetersiz!";
                    transaction.update(urunRef, { stok: yeniStok });
                });
            }
            whatsappSiparisiGonder(adres);
        } catch (error) {
            alert("Hata oluÅŸtu: " + error);
        }
    }

    function whatsappSiparisiGonder(adres) {
        let urunMetni = "";
        sepet.forEach((urun, index) => {
            urunMetni += `${index + 1}. ${urun.ad} - ${urun.fiyat.toFixed(2)} TL%0A`;
        });
        const toplamFiyat = document.getElementById('toplam-fiyat').innerText;
        const telNo = "905052464244"; 
        const mesaj = `*YENÄ° SÄ°PARÄ°Å (MEG KURUYEMÄ°Å)*%0A%0A*ÃœrÃ¼nler:*%0A${urunMetni}%0A*Toplam Tutar:* ${toplamFiyat} TL%0A%0A*Teslimat Adresi:*%0A${adres}`;
        window.open(`https://api.whatsapp.com/send?phone=${telNo}&text=${mesaj}`, '_blank');
        sepet = []; toplam = 0; guncelle();
    }

    // --- GÄ°RÄ°Å, KAYIT VE Ã‡IKIÅ FONKSÄ°YONLARI ---

    function panelAc(tip) {
        const panel = document.getElementById("panelIcerik");
        if(tip === 'giris') {
            panel.innerHTML = `
                <h3>GiriÅŸ</h3>
                <div class="input-grubu">
                    <input type="text" id="giris-email" placeholder="E-posta">
                </div>
                <div class="input-grubu">
                    <input type="password" id="giris-sifre" placeholder="Åifre">
                </div>
                <button class="giris-btn" onclick="sistemeGirisYap()">GÄ°RÄ°Å</button>`;
        } else {
            panel.innerHTML = `
                <h3>KayÄ±t Ol</h3>
                <div class="input-grubu"><input type="text" id="kayit-ad" placeholder="Ad Soyad"></div>
                <div class="input-grubu"><input type="email" id="kayit-email" placeholder="E-posta"></div>
                <div class="input-grubu"><input type="password" id="kayit-sifre" placeholder="Åifre"></div>
                <button class="giris-btn" onclick="musteriKaydet()" style="background:green;">KAYDET</button>`;
        }
        document.getElementById("yanPanel").style.width = "350px";
    }

    function sistemeGirisYap() {
        const email = document.getElementById('giris-email').value;
        const sifre = document.getElementById('giris-sifre').value;

        if (!email || !sifre) { alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun!"); return; }

        db.collection("musteriler")
            .where("eposta", "==", email)
            .where("sifre", "==", sifre)
            .get()
            .then((querySnapshot) => {
                if (!querySnapshot.empty) {
                    const kullanici = querySnapshot.docs[0].data();
                    alert("HoÅŸ geldiniz, " + kullanici.adSoyad);
                    
                    // GiriÅŸ yapÄ±nca header'Ä± gÃ¼ncelle ve Ã‡Ä±kÄ±ÅŸ butonunu ekle
                    document.getElementById('kullanici-alani').innerHTML = `
                        <span>ğŸ‘¤ Merhaba, <b>${kullanici.adSoyad}</b></span> | 
                        <button onclick="cikisYap()" style="background:none; border:none; cursor:pointer; color:red; font-weight:bold;">Ã‡Ä±kÄ±ÅŸ Yap</button>
                    `;
                    panelKapat();
                } else {
                    alert("HatalÄ± e-posta veya ÅŸifre!");
                }
            })
            .catch((error) => { console.error("GiriÅŸ hatasÄ±: ", error); });
    }

    function cikisYap() {
        if(confirm("Ã‡Ä±kÄ±ÅŸ yapmak istediÄŸinize emin misiniz?")) {
            // Header'Ä± eski haline getir
            document.getElementById('kullanici-alani').innerHTML = `
                <button onclick="panelAc('giris')" style="background:none; border:none; cursor:pointer; font-size:1.1em;">ğŸ‘¤ GiriÅŸ Yap</button> | 
                <button onclick="panelAc('kayit')" style="background:none; border:none; cursor:pointer; font-size:1.1em;">ğŸ“ KayÄ±t Ol</button>
            `;
            alert("BaÅŸarÄ±yla Ã§Ä±kÄ±ÅŸ yapÄ±ldÄ±.");
        }
    }

    function musteriKaydet() {
        const ad = document.getElementById('kayit-ad').value;
        const mail = document.getElementById('kayit-email').value;
        const sifre = document.getElementById('kayit-sifre').value;

        if(!ad || !mail || !sifre) { alert("TÃ¼m alanlarÄ± doldurun!"); return; }

        db.collection("musteriler").add({
            adSoyad: ad, eposta: mail, sifre: sifre, tarih: new Date()
        }).then(() => {
            alert("KayÄ±t BaÅŸarÄ±lÄ±! ArtÄ±k giriÅŸ yapabilirsiniz.");
            panelAc('giris');
        });
    }

    function panelKapat() { document.getElementById("yanPanel").style.width = "0"; }
    
    function filtrele(k) {
        document.querySelectorAll('.urun-karti').forEach(kart => {
            kart.style.display = (k === 'hepsi' || kart.dataset.kategori === k) ? 'block' : 'none';
        });
    }

    function aiAra() {
        const terim = document.getElementById('ai-arama').value;
        const kartlar = document.querySelectorAll('.urun-karti');
        const veriler = Array.from(kartlar).map((k, i) => ({ id: i, ad: k.querySelector('h3').innerText }));
        if(!terim) { filtrele('hepsi'); return; }
        const fuse = new Fuse(veriler, { keys: ['ad'], threshold: 0.4 });
        const sonuc = fuse.search(terim).map(s => s.item.id);
        kartlar.forEach((k, i) => k.style.display = sonuc.includes(i) ? 'block' : 'none');
    }

    function aiDanis() {
        const soru = document.getElementById('ai-soru').value.toLowerCase();
        let cevap = "Åu an en taze Ã¼rÃ¼nÃ¼mÃ¼z Antep FÄ±stÄ±ÄŸÄ±!";
        if(soru.includes("diyet")) cevap = "Diyet iÃ§in Ã‡iÄŸ Badem Ã¶neririm!";
        document.getElementById('ai-cevap').innerText = cevap;
    }

    window.onload = urunleriYukle;
</script>
</body>
</html>